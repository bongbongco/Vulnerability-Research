<?xml version="1.0" encoding="utf-8"?>
<Peach xmlns="http://peachfuzzer.com/2012/Peach" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://peachfuzzer.com/2012/Peach /peach/peach.xsd">

	<DataModel name="Chunk">
		<String name="ID" length="4" padCharacter=" "/>
		<Number name="Size" size="32" endian="big">
				<Relation type="size" of="Data"/>
		</Number>
		<Blob name="Data"/>
	</DataModel>

	<DataModel name="COMMChunk" ref="Chunk">
		<String name="ID" value="COMM" token="true"/>
		<Number name="numChannels" size="16"/>
		<Number name="numSampleFrames" size="32"/>
		<Number name="sampleSize" size="16"/>
		<String name="sampleRate" length="10"/>
	</DataModel>

	<DataModel name="FORMChunk" ref="Chunk">
		<String name="ID" value="FORM" token="true"/>
	</DataModel>

	<DataModel name="INSTChunk" ref="Chunk">
		<String name="ID" value="INST" token="true"/>
	</DataModel>

	<DataModel name="MARKChunk" ref="Chunk">
		<String name="ID" value="MARK" token="true"/>
	</DataModel>

	<DataModel name="SKIPChunk" ref="Chunk">
		<String name="ID" value="SKIP" token="true"/>
	</DataModel>

	<DataModel name="SSNDChunk" ref="Chunk">
		<String name="ID" value="SSND" token="true"/>
		<Number name="offset" size="32" value="0"/>
	</DataModel>

	<!-- Defines the format of a AIFF file -->
	<DataModel name="Aiff">
	    <!-- aiff header -->
			<String name="ID" value="FORM" token="true"/>
			<Number name="Size" value="46992" size="32"/>
			<String name="Type" value="AIFF" token="true"/>

	    <Choice name="DataChunk" maxOccurs="30000">
	    	<Block ref="Chunk"/>    
		<Block ref="COMMChunk"/>
	        <Block ref="FORMChunk"/>
	        <Block ref="INSTChunk"/>
	        <Block ref="MARKChunk"/>
	        <Block ref="SKIPChunk"/>
	        <Block ref="SSNDChunk"/>
	    </Choice>
	</DataModel>

	<!-- This is our simple aiff state model -->
	<StateModel name="TheState" initialState="Initial">
	    <State name="Initial">

	        <!-- Write out our aiff file -->
	        <Action type="output">
	            <DataModel ref="Aiff"/>
	            <!-- This is our sample file to read in -->
	            <Data fileName="C:\Peach_fuzz\samples_aiff\sample.aif"/>
	        </Action>

	        <Action type="close"/>

	        <!-- Launch the target process -->
	        <Action type="call" method="StartMPlayer" publisher="Peach.Agent"/>
	    </State>
	</StateModel>


	<!-- TODO: Configure agent -->
	<!--<Agent name="TheAgent" location="http://127.0.0.1:9000"/>-->

	<Agent name="WinAgent">
	   <Monitor class="WindowsDebugger">

	        <!-- The command line to run.  Notice the filename provided matched up
	             to what is provided below in the Publisher configuration -->
	        <Param name="CommandLine" value="C:\Program Files (x86)\VUPlayer\VUPlayer.exe fuzzed.aif"/>
			<!-- windbg 경로를 설정합니다. 64비트 peach라면 반드시 64비트 디버거여야 함 -->
	   		<Param name="WinDbgPath" value="C:\Program Files\Debugging Tools for Windows (x64)\"/>

	        <!-- This parameter will cause the debugger to wait for an action-call in
	             the state model with a method="StartMPlayer" before running
	             program.
	        -->
	        <Param name="StartOnCall" value="StartMPlayer"/>

	        <!-- This parameter will cause the monitor to terminate the process
	             once the CPU usage reaches zero.
	        -->
	        <Param name="CpuKill" value="true"/>

	    </Monitor>

	    <!-- Enable heap debugging on our process as well. -->
	    <Monitor class="PageHeap">
	        <Param name="Executable" value="C:\Program Files (x86)\VUPlayer\VUPlayer.exe"/>
	        <Param name="WinDbgPath" value="C:\Program Files\Debugging Tools for Windows (x64)\"/>
	    </Monitor>

	</Agent>

    <Test name="Default">
    <Agent ref="WinAgent" platform="windows"/>


    <StateModel ref="TheState"/>

    <Publisher class="File">
        <Param name="FileName" value="fuzzed.aif"/>
    </Publisher>
    <Logger class="Filesystem">
        <Param name="Path" value="logs"/>
    </Logger>
	</Test>


</Peach>
<!-- end -->
