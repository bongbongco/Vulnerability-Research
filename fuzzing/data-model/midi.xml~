<?xml version="1.0" encoding="utf-8"?>
<Peach xmlns="http://peachfuzzer.com/2012/Peach" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://peachfuzzer.com/2012/Peach /peach/peach.xsd">

    <!-- Defines the format of a MIDI file -->
    <DataModel name="HeaderChunk">
        <String name="MagicNumber" value="MThD" token="true"/>
        <Number name="HeaderSize" value="6" size="32"/>
        <Number name="FormatType" value="1" size="16"/>
        <Number name="NumOfTrack" size="16">
            <Relation type="count" of="Track"/>
        </Number>
        <Number name="TimeDivision" size="16"/>
    </DataModel>

    <DataModel name="TrackHeader">
        <String name="MagicNumber" value="MTrK" token="true"/>
        <Number name="TrackChunkSize" size="32">
            <Relation type="size" of="TrackChunk"/>
        </Number>
    </DataModel>

    <DataModel name="TrackChunk">
        <Blob name="Data"/>    
    </DataModel>

    <DataModel name="MIDI">
        <Block ref="HeaderChunk"/>
        <Choice name="Track">            
            <Block ref="TrackHeader"/>
            <Block ref="TrackChunk"/>
        </Choice>
    </DataModel>
    <!-- This is our simple midi state model -->
    <StateModel name="TheState" initialState="Initial">
        <State name="Initial">

            <!-- Write out our midi file -->
            <Action type="output">
                <DataModel ref="MIDI"/>
                <!-- This is our sample file to read in -->
                <Data fileName="C:\Peach_fuzz\samples_midi\sample.mid"/>
            </Action>

            <Action type="close"/>

            <!-- Lmidinch the target process -->
            <Action type="call" method="StartMPlayer" publisher="Peach.Agent"/>
        </State>
    </StateModel>


    <!-- TODO: Configure agent -->
     <!--<Agent name="TheAgent" location="http://127.0.0.1:9000"/>-->

    <Agent name="WinAgent">
        <Monitor class="WindowsDebugger">

            <!-- The command line to run.  Notice the filename provided matched up
             to what is provided below in the Publisher configuration -->
            <Param name="CommandLine" value="C:\Program Files (x86)\Windows Media Player\wmplayer.exe fuzzed.mid"/>
            <!-- windbg 경로를 설정합니다. 64비트 peach라면 반드시 64비트 디버거여야 함 -->
            <Param name="WinDbgPath" value="C:\Program Files\Debugging Tools for Windows (x64)\"/>

            <!-- This parameter will cmidise the debugger to wait for an action-call in
             the state model with a method="StartMPlayer" before running
             program.
             -->
            <Param name="StartOnCall" value="StartMPlayer"/>

            <!-- This parameter will cmidise the monitor to terminate the process
             once the CPU usage reaches zero.
             -->
            <Param name="CpuKill" value="true"/>

        </Monitor>

        <!-- Enable heap debugging on our process as well. -->
        <Monitor class="PageHeap">
            <Param name="Executable" value="C:\Program Files (x86)\Windows Media Player\wmplayer.exe"/>
            <Param name="WinDbgPath" value="C:\Program Files\Debugging Tools for Windows (x64)\"/>
        </Monitor>

    </Agent>

    <Test name="Defmidilt">
        <Agent ref="WinAgent" platform="windows"/>


        <StateModel ref="TheState"/>

        <Publisher class="File">
            <Param name="FileName" value="fuzzed.mid"/>
        </Publisher>
        <Logger class="Filesystem">
            <Param name="Path" value="logs"/>
        </Logger>
    </Test>


</Peach>
<!-- end -->

