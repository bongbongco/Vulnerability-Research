# Sulley

[Sulley](https://github.com/OpenRCE/sulley)는 파이썬으로 개발된 퍼저로 많은 사용자를 보유한 인기있는 도구이다. Gray Hat Python이나 인터넷의 여러 블로그에서 쉽게 사용법을 찾아볼 수 있어 퍼징 입문을 위해 많이 활용되고 있으며 파이썬으로 개발된 덕분에 커스터마이징을 위한 기본 뼈대로도 사용되고 있다. [Wiki 페이지](https://github.com/OpenRCE/sulley/wiki/Windows-Installation)를 통해서 설치방법을 제공해주고 있으나, 진행 도중 설치 에러로 막히는 경우가 많다. 이는 컴파일 관련 문제로 [Microsoft Visual C++ Compiler for Python 2.7
](https://www.microsoft.com/en-us/download/details.aspx?id=44266) 설치 후 "Visual c++ command prompt"를 이용하여 진행하면 대부분 해결 가능하다.

튜토리얼로 사용되는 [warftpd 1.65](http://www.warftp.org/files/1.6_Series/ward165.exe)퍼징 테스트를 진행해보자. 

## ftp.py
퍼징 테스트를 위해서 FTP 통신 표준 데이터 정의가 필요하다. request 폴더 밑에 ftp.py 파일을 생성하고 아래 코드를 입력하자.
```python
from sulley import *

s_initialize("user")
s_static("USER")
s_delim(" ")
s_string("justin")
s_static("\r\n")

s_initialize("pass")
s_static("PASS")
s_delim(" ")
s_string("justin")
s_static("\r\n")

s_initialize("cwd")
s_static("CWD")
s_delim(" ")
s_string("c:")
s_static("\r\n")

s_initialize("dele")
s_static("DELE")
s_delim(" ")
s_string("c:\\test.txt")
s_static("\r\n")

s_initialize("mdtm")
s_static("MDTM")
s_delim(" ")
s_string("C:\\boot.ini")
s_static("\r\n")

s_initialize("mkd")
s_static("MKD")
s_delim(" ")
s_string("C:\\TESTDIR")
s_static("\r\n")
```
FTP를 사용해본적이 있다면 친숙한 키워드를 확인할 수 있다. (코드에서 확인할 수 있듯이 테스트를 위해 justin/justin 계정을 생성하여 사용하고 있다.) 

## ftp_session.py
request/ftp.py 에 정의한 데이터를 활용하여 테스트를 수행하는 ftp_session.py 파일을 생성하자. 
```python
from sulley import *
from requests import ftp

def receive_ftp_banner(sock):
    sock.recv(1024)

sess = sessions.session(session_filename="C:\\warftpd.session")
target = sessions.target("127.0.0.1", 21)
target.netmon = pedrpc.client("127.0.0.1", 26001)
target.procmon = pedrpc.client("127.0.0.1", 26002)
target.procmon_options = {"proc_name" : "war-ftpd.exe", 
		"stop_commands" : ['wmic process where (name="war-ftpd.exe") delete'],
        "start_commands":['C:\\Program Files\\War-ftpd\\war-ftpd.exe'],}

sess.pre_send = receive_ftp_banner

sess.add_target(target)

sess.connect(s_get("user"))
sess.connect(s_get("user"), s_get("pass"))
sess.connect(s_get("pass"), s_get("cwd"))
sess.connect(s_get("pass"), s_get("dele"))

sess.connect(s_get("pass"), s_get("mdtm"))
sess.connect(s_get("pass"), s_get("mkd"))

sess.fuzz()
```

## process_monitor.py
프로세스 모니터링을 위해서 아래 명령어를 수행하자. (포트를 26002로 지정하였으므로 -P 옵션을 사용하지 않는다. 26002로 지정하지 않은 경우 `python process_monitor.py -c C:\warftpd.crash -P war-ftpd.exe`로 프로세스를 지정한다.)
```
python process_monitor.py -c C:\warftpd.crash
```

## network_monitor.py
네트워크 모니터링을 위해서 아래 명령어를 수행하자. 로그를 저장할 C:\pcaps 디렉터리는 network_monitor.py 실행 전 미리 생성해야 정상 구동된다.
```
python network_monitor.py -d 0 -f "src or dst port 21" -P C:\pcaps\
```

## Start Fuzzing
이제 warftpd를 실행하여 FTP 서비스 시작 후 ftp_session.py 파일을 실행하여 퍼징 테스트를 시작하자. 이 때 퍼징 테스트 중 종료된 프로세스를 바로 재시작할 수 있도록 warfpd 옵션에서 배너 제거와 시작 시 서비스 시작 항목을 설정한다. 퍼징 진행은 `http://127.0.0.1:26000`에서 확인이 가능하다. 
