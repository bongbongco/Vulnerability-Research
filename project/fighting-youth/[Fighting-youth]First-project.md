# 힘내라 청춘 - 첫 번째 프로젝트
## 오디오 파일 포맷 퍼징_첫 번째 기록

2017년 목표 중에 하나 였던 취약점 찾기를 한해가 끝날 무렵 시작하게 되었다. 취약점은 프로그래밍 실수에서 비롯된다는 점에 착안하여 비교적 쉬운 파일 구조의 오디오 파일 퍼징을 프로젝트 주제를 잡았다. 복잡한 단일 모델 처리와 간단한 다중 모델 처리 시 프로그래밍 실수는 언제 더 많이 발생하는 가에 대한 고민을 했을 때, 복잡성이 낮더라도 여러 모델을 처리해야 할 경우 논리적 결함이 발생할 확률이 더 높지 않는 가하는 결론에 도달했다. 

먼저 파일 구조 분석을 시작한 것은 WAV와 AIFF 파일이다. WAV 파일은 검색 시 자료를 쉽게 구할 수 있으며, Peach Fuzzer에서 Tutorial로 제공해주는 파일 구조라서 도입 단계에서 진행 계획을 수립하기에 적합하다고 판단되었다. AIFF 파일은 개발된지 상당히 오래된 구조로 무손실 음원을 위해 활용되는 파일이다. 

WAV 파일 다음으로 AIFF 파일을 선택한 이유는 파일 퍼징 시 코드 커버리지를 높일 수 있는 방법은 해당 프로그램이 지원하는 파일 형식을 모두 대입하는 것 또한 하나의 방법이 될 수 있지 않을 까하는 판단에서 선택하였다. 많이 사용되는 mp3 나 mp4 와 같은 파일 형식은 이미 여러 퍼저들의 다양한 데이터 모델을 통해서 검증되었으리라 생각된다. 이에 비교적 검증 횟수가 적은 코드 경로를 거치기 위해서 사용률이 낮은 파일 형식을 선별하여 퍼징 테스트를 진행하고자 한다.

목표 프로그램 테스트 수행 전 단계로 VUPlayer를 활용하고 있으며,  아래는 현재 작성 중인 AIFF 데이터모델이다.

```xml
<?xml version="1.0" encoding="utf-8"?>
<Peach xmlns="http://peachfuzzer.com/2012/Peach" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://peachfuzzer.com/2012/Peach /peach/peach.xsd">
    
    <DataModel name="Chunk">
        <String name="ID" length="4" padCharacter=" "/>
        <Number name="Size" size="32" endian="big">
            <Relation type="size" of="Data"/>
        </Number>
        <Blob name="Data"/>
    </DataModel>
    
    <DataModel name="COMMChunk" ref="Chunk">
        <String name="ID" value="COMM" token="true"/>
        <Number name="numChannels" size="16"/>
        <Number name="numSampleFrames" size="32"/>
        <Number name="sampleSize" size="16"/>
        <String name="sampleRate" length="10"/>
    </DataModel>
    
    <DataModel name="FORMChunk" ref="Chunk">
        <String name="ID" value="FORM" token="true"/>
    </DataModel>
    
    <DataModel name="INSTChunk" ref="Chunk">
        <String name="ID" value="INST" token="true"/>
    </DataModel>
    
    <DataModel name="MARKChunk" ref="Chunk">
        <String name="ID" value="MARK" token="true"/>
    </DataModel>
    
    <DataModel name="SKIPChunk" ref="Chunk">
        <String name="ID" value="SKIP" token="true"/>
    </DataModel>
    
    <DataModel name="SSNDChunk" ref="Chunk">
        <String name="ID" value="SSND" token="true"/>
        <Number name="offset" size="32" value="0"/>
    </DataModel>
    
    <!-- Defines the format of a WAV file -->
    <DataModel name="Aiff">
        <!-- aiff header -->
        <String name="ID" value="FORM" token="true"/>
        <Number name="Size" value="46992" size="32"/>
        <String name="Type" value="AIFF" token="true"/>
        
        <Choice name="DataChunk" maxOccurs="30000">
            <Block ref="COMMChunk"/>
            <Block ref="FORMChunk"/>
            <Block ref="INSTChunk"/>
            <Block ref="MARKChunk"/>
            <Block ref="SKIPChunk"/>
            <Block ref="SSNDChunk"/>
            <Block ref="Chunk"/>
        </Choice>
    </DataModel>
    
    <!-- This is our simple wave state model -->
    <StateModel name="TheState" initialState="Initial">
        <State name="Initial">
            
            <!-- Write out our wave file -->
            <Action type="output">
                <DataModel ref="Aiff"/>
                <!-- This is our sample file to read in -->
                <Data fileName="C:\Peach_fuzz\samples_aiff\sample.aif"/>
            </Action>
            
            <Action type="close"/>
            
            <!-- Launch the target process -->
            <Action type="call" method="StartMPlayer" publisher="Peach.Agent"/>
        </State>
    </StateModel>
    
    
    <!-- TODO: Configure agent -->
     <!--<Agent name="TheAgent" location="http://127.0.0.1:9000"/>-->
    
    <Agent name="WinAgent">
        <Monitor class="WindowsDebugger">
            
            <!-- The command line to run.  Notice the filename provided matched up
             to what is provided below in the Publisher configuration -->
            <Param name="CommandLine" value="C:\Program Files (x86)\VUPlayer\VUPlayer.exe fuzzed.aif"/>
            <!-- windbg 경로를 설정합니다. 64비트 peach라면 반드시 64비트 디버거여야 함 -->
            <Param name="WinDbgPath" value="C:\Program Files\Debugging Tools for Windows (x64)\"/>
            
            <!-- This parameter will cause the debugger to wait for an action-call in
             the state model with a method="StartMPlayer" before running
             program.
             -->
            <Param name="StartOnCall" value="StartMPlayer"/>
            
            <!-- This parameter will cause the monitor to terminate the process
             once the CPU usage reaches zero.
             -->
            <Param name="CpuKill" value="true"/>
            
        </Monitor>
        
        <!-- Enable heap debugging on our process as well. -->
        <Monitor class="PageHeap">
            <Param name="Executable" value="C:\Program Files (x86)\VUPlayer\VUPlayer.exe"/>
            <Param name="WinDbgPath" value="C:\Program Files\Debugging Tools for Windows (x64)\"/>
        </Monitor>
        
    </Agent>
    
    <Test name="Default">
        <Agent ref="WinAgent" platform="windows"/>
        
        
        <StateModel ref="TheState"/>
        
        <Publisher class="File">
            <Param name="FileName" value="fuzzed.aif"/>
        </Publisher>
        <Logger class="Filesystem">
            <Param name="Path" value="logs"/>
        </Logger>
    </Test>
    
    
</Peach>
<!-- end -->
```
