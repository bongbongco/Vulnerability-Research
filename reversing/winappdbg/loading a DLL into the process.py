from winappdbg import System, Process, HexDump
import sys
import pprint


def print_threads_and_modules(pid):

    process = Process(pid)
    print "Process %d" % process.get_pid()

    print "Threads:"
    for thread in process.iter_threads():
        print "\t %d" % thread.get_tid()

    print "Modules:"
    bits = process.get_bits()
    for module in process.iter_modules():
        print "\t%s\t%s" % (
                HexDump.address(module.get_base(), bits),
                module.get_filename()
                )

def starting_process(path):
    system = System()
    process = system.start_process(path)
    print "Started process %d (%d bits)" % (process.get_pid(), process.get_bits())
    return process.get_pid()

def stoping_process(pid):
    process = Process(pid)
    process.kill()
    print "Kill process"

def process_read(pid):#, address, length):
    process = Process(pid)
    data = process.read(address, length)
    return data

def show_command_line(pid):
    process = Process(pid)
    print process.get_command_line()

def show_environment(pid):
    process = Process(pid)
    environment = process.get_environment()
    for variable, value in sorted(environment.items()):
        print "%s=%s" % (variable, value)

def load_dll(pid, filename):
    process = Process(pid)
    process.inject_dll(filename)

if __name__ =="__main__":
    #system = System()
    #pid = system.argv_to_cmdline(sys.argv[1:])
    #print_threads_and_modules(int(pid))

    path = "C:\\Program Files (x86)\\GRETECH\\GOMAudio\\Goma.exe"
    pid = starting_process(path)
    print_threads_and_modules(pid)
    #process_read(pid) 
    show_command_line(pid)
    #stoping_process(pid)
    show_environment(pid)
