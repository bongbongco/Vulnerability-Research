# C 언어 시큐어코딩 - Declare and Initialization 1

## 적절한 저장 기간을 가진 객체 선언

모든 객체는 수명을 결정하는 저장 기간이 있다. : static, thread, automatic, or allocated.

> 객체 수명은 실행 중 저장 장치에 예약된 기간 동안 보장된다. 객체가 존재하고, 상수 주소를 가지며, 수명 기간 동안 저장된 값을 유지한다. 하지만 수명 기간이 지나고 발생하는 참조의 동작에 대한 정의는 없으며 포인터가 가리키는 객체의 수명이 끝나면 포인터의 값은 불확실해진다.

객체의 수명 기간 지난 후 접근을 시도해서는 안된다. 그러한 시도는 정의되지 않은 동작으로 악용될 수 있는 취약점으로 이어질 수 있다.

### 잘못된 코드 예제 (다른 저장 기간)
 이 코드 예제는 자동 저장 기간을 갖는 변수 `c_str`의 주소를 정적 저장 기간을 갖는 변수 `p`에 할당한다. 할당 자체는 유효하지만 `dont_do_this()`의 끝에서와 같이 `p`가 주소를 보유하고 있는 동안에 `c_str`이 범위를 벗어나는 것은 유효하지 않다.
```c
#include <stdio.h>
  
const char *p;
void dont_do_this(void) {
  const char c_str[] = "This will change";
  p = c_str; /* Dangerous */
}
 
void innocuous(void) {
  printf("%s\n", p);
}
 
int main(void) {
  dont_do_this();
  innocuous();
  return 0;
}
```

### 올바른 코드 예제 (동일한 저장 기간)
이 예제에서 `p`는 `c_str`과 동일한 저장 기간으로 선언되므로 `p`는 `this_is_OK()` 외부에서 불확정 값을 가지지 않는다.
```c
void this_is_OK(void) {
  const char c_str[] = "Everything OK";
  const char *p = c_str;
  /* ... */
}
/* p is inaccessible outside the scope of string c_str */
```
또한 `p`와 `c_str`을 정적 저장 기간으로 선언할 수 있다.

### 올바른 코드 예제 (다른 저장 기간)
만약 `p`는 정적 저장 기간으로 정의하고 `c_str`는 좀 더 제한된 지속 기간으로 정의해야 한다면, `c_str`이 삭제되기 전에 `p`를 NULL로 설정할 수 있다. 이로인해 `p`에 대한 모든 참조가 NULL  검사를 해야 할지라도 `p`가 불확정 값을 갖지 못하게 한다.  
```c
const char *p;
void is_this_OK(void) {
  const char c_str[] = "Everything OK?";
  p = c_str;
  /* ... */
  p = NULL;
}
```

### 잘못된 코드 예제 (반환 값)
이 예제의 `init_array()` 함수는 호출자가 접근할 수 있는 자동 저장 기간의 문자 배열 포인터를 반환한다.
```c
char *init_array(void) {
  char array[10];
  /* Initialize array */
  return array;
}
```
일부 컴파일러는 자동 저장 기간을 가진 객체에 대한 포인터 객체에 대한 포인터가 예제에서와 같이 함수에서 반환 될 때 경고 메시지를 출력한다. 

### 올바른 코드 예제 (반환 값)
이러한 경우 해결책은 프로그래머의 의도에 달려있다. 만약 배열의 값을 수정하고 그 수정을 `init_array()`의 범위 밖에서 유지하려는 의도가 있는 경우, 배열을 다른 위치에 선언하고 `init_array()`에  인수로 전달하여 원하는 동작을 수행할 수 있다.
```c
#include <stddef.h>
void init_array(char *array, size_t len) {
  /* Initialize array */
  return;
}
 
int main(void) {
  char array[10];
  init_array(array, sizeof(array) / sizeof(array[0]));
  /* ... */
  return 0;
}
```

### 잘못된 코드 예제 (출력 파라미터)
이 여제는 `squirrel_away()` 함수는 지역 변수 `local`에 대한 포인터를 함수 파라미터 `ptr_param`이 가리키는 위치에 저장한다. `squirrel_away()`가 반환되면 포인터 `ptr_param`은 수명이 만료된 변수를 가리키게 된다.
```c
void squirrel_away(char **ptr_param) {
  char local[10];
  /* Initialize array */
  *ptr_param = local;
}
 
void rodent(void) {
  char *ptr;
  squirrel_away(&ptr);
  /* ptr is live but invalid here */
}
```

### 올바른 코드 예제 (출력 파라미터)
변수 `local`을 정적 저장기간으로 처리하면 `ptr`은 `rodent()` 함수 내에서 로컬 배열을 참조하는 데 사용할 수 있다.
```c
char local[10];
  
void squirrel_away(char **ptr_param) {
  /* Initialize array */
  *ptr_param = local;
}
 
void rodent(void) {
  char *ptr;
  squirrel_away(&ptr);
  /* ptr is valid in this scope */
}
```
