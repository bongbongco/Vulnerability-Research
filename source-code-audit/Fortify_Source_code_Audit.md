# 포티파이 진단 정리

* 전제 사항 : 빌드 되지 않는 프로젝트는 진단이 불가하다. 빌드 성공을 확인하여야 하기 때문에 IDE 혹은 빌드 툴을 이용해서 진단하는 것이 진단 실패 혹은 소스 파일이 미포함된 체로 진단이 수행되는 일을 막을 수 있다. 따라서 Fortify에서 제공해주는 클라이언트를 이용하지 않고 각 환경에 맞는 플러그인을 활용하여 진단한다. 진단 대상 협의 시 실제 소스코드를 전달받는 것 보다 Github 저장소 주소를 전달받는 것이 좋다. 추가 구성 시 필요한 외부 프로젝트의 링크를 확인 하거나, 오탐 판단 시 변경 이력 및 커밋 멘트를 이용하여 소스 용도를 파악하는 데 유용하다.


## 닷넷 환경 -> 비주얼 스튜디오로 진행
소스 파일을 전달 받은 후 솔루션이 성공적으로 빌드된다면 곧바로 진단을 수행하면 된다. 진단은 프로젝트 별로 각각 진행하는 것이 진단 수행과 취약점 분석이 용이하기 때문에 개별로 진단을 수행한다. 만약 솔수션 빌드에 실패하였다면 라이브러리를 읽어오지 못하는 경우로 Nuget을 이용해서 누락된 라이브러리를 채워준다.
- nuget source server : 
  1) Nuget Release / http://nuget.example.com/nuget/release
  2) Nuget Prerelease / http://nuget.example.com/nuget/prerelease
  
라이브러리가 모두 존재하는 데 빌드에 실패한다면 project 파일의 수정이 필요하다. 라이브러리 위치가 상대경로로 지정되어 있는 경우 읽어오지 못하는 경우가 있으므로 에러가 발생하는 라이브러리의 위치를 절대 경로로 수정하면 에러를 제거할 수 있다.

## Node.js -> 비주얼 스튜디오에 모듈 설치하여 진행
비주얼 스튜디오에 Node.JS 개발을 위한 확장 도구가 존재한다. 이를 설치하여 비주얼 스튜디오에서 진단을 수행한다. 진단 시 발생되는 오류는 패키지가 없어서 발생되는 것으로 해당 패키지를 내부 저장소에서 찾아서 추가해준다. 내부 저장소에 없는 경우는 npm을 이용하여 패키지를 설치한다.
- 진단 환경 구축
URL : https://github.com/Microsoft/nodejstools/releases/tag/v1.2.RTW 
npm install --registry http://prm.example.com/nexus/content/groups/npm-group/
npm install npm -g
- Required Visual Studio 2015 update 3

## JSP -> 빌드 도구로 진단 진행
자바 웹 프로젝트의 경우 빌드 툴(Maven 혹은 Gradle)을 이용하여 개발하고 있으므로 이를 활용한 진단이 필요하다. 프로젝트 내 'pom.xml' 을 포함하고 있다면 Maven을 'build.gradle' 을 포함하고 있다면 Gradle을 이용한다. 만약 빌드 툴을 이용하지 않는 프로젝트라면 이클립스의 플러그인을 이용하여 진단을 수행한다.

진단을 위해서는 개발 시 사용된 JDK 버전의 입력이 필요하다. (빌드 설정 파일(ex. pom.xml) 에서 확인이 가능한데 버전에 종속적인 코드가 없는 경우 '${java.version}' 으로 작성되어 있고 이 경우 자신의 PC에 설치된 JDK 버전을 입력하면 된다.)

Spring Framework를 사용한 프로젝트가 대부분이므로 STS를 설치한다. (이클립스에 Spring Framework 플러그인을 추가해서 사용해도 무방하다.)
IDE에서 진단을 수행할 수 있게 Fotify 설치 폴더 내 이클립스 플러그인을 설치한다.
	Help -> Install New Software
	(ex. Fortify - file:/C:/Program Files/HP_Fortify/HP_Fortify_SCA_and_Apps_4.40/plugins/eclipse/)

빌드 툴을 설치하고 환경변수에 추가한다.
	Maven : http://maven.apache.org/download.cgi
	Gradle : https://gradle.org/

### Maven을 사용한 프로젝트 진단을 위해 Fortify 설치 폴더 내 Maven 플러그인을 설치한다.

```
	mvn clean package install
	(ex. C:\Program Files\HP_Fortify\HP_Fortify_SCA_and_Apps_4.40\Samples\advanced\maven-plugin)

//Maven Setting.xml 파일에 Fortify 관련 plugin group을 추가한다.
//	<pluginGroups xmlns="http://maven.apache.org/SETTINGS/1.1.0">
//		<pluginGroup>com.fortify.ps.maven.plugin</pluginGroup>
//	</pluginGroups>

mvn sca:clean
mvn sca:translate
mvn sca:scan
```
	
### Gradle 설치 후 프로젝트 내 gradle.build 파일에 진단을 위해 아래 구문을 추가한다.
(Fortify에서 제공하는 Gradle plugin이 존재하지 않기 때문에 프로젝트 내 build.gradle 파일을 직접 수정해야한다.)

```
// Fortify configuration
configurations {
 fortify { extendsFrom compile }
}

// pull in the fortify libs for the new configuration
dependencies {
 fortify fileTree(dir: 'C:/Program Files/HP_Fortify/HP_Fortify_SCA_and_Apps_4.40/Core/lib', include: '*.jar')
}

task fortifyReport(dependsOn: compileJava) << {
	ant.properties['build.compiler']='com.fortify.dev.ant.SCACompiler'
	ant.typedef(name: 'sca', classname: 'com.fortify.dev.ant.SourceanalyzerTask',
	classpath: configurations.fortify.asPath)

	ant.sca(jdk:"1.7", // JDK 버전
	maxHeap:'4096M' ,
	use64bit:true ,
	debug:true ,
	verbose:true ,
	failonerror:true ,
	scan:true ,
	logFile:file("$buildDir/fortify/Fortify.log"),
	resultsFile:file("$buildDir/fortify/result.fpr")
	){
	   fileset(dir:'src') { //소스 경로 설정
		  include(name:'**/*.java') // 자바 파일 진단
		  include(name:'**/*.jsp') // 자바서블릿페이지 파일 진단
		  include(name:'**/*.js') // 자바스크립트 파일 진단
		  include(name:'**/*.html') // HTML 파일 진단
		} 
	}
}
```

삽입한 task 명으로 진단 수행 
(ex. gradle fortifyReport)


### Ant를 사용하여 빌드하는 패키지의 경우, 다음을 수행해야 한다.
>Blog : https://www.astechconsulting.com/blog/quick-and-easy-fortify-scans
>Youtube : https://youtu.be/eBudIxqEmR8

Ant 정상 동작 확인
```
ant -v
```

java 파일을 컴파일한다.
```
ant -Dbuild.compiler=com.fortify.dev.ant.SCACompiler -Dsourceanalyzer.buildid=[your build id] -lib [Fortify Home]/Core/lib/sourceanalyzer.jar -Dsourceanalyzer.maxHeap=[some numeric value – I usually use at least 500]M
ant clean
```

끝나면 jsp, xml, properties 및 js 파일과 나머지 파일을 컴파일 한다.
```
sourceanalyzer -b [your build id] -verbose -cp "**/*.jar;[path to your compiled classes, e.g., WebContent/WEB-INF/classes]" -source "[version of java source, e.g., 1.7]" "**/*.jsp" "**/*.xml" "**/*.js" "**/*.properties" “**/*.java”
```

이제 번역 된 파일을 스캔하고 fpr을 출력으로 생성한다 :
```
sourceanalyzer -b [your build id] -scan -f [your fpr name].fpr
```

## 트러블슈팅
1) 빌드 툴에서 자동으로 추가하지 못하는 라이브러리는 자체 라이브러리 혹은 설정된 저장소에 업로드되어 있지 않은 라이브러리이므로...

2) The superclass "javax.servlet.http.HttpServlet" was not found on the Java Build Path
프로젝트 우클릭 -> Build Path -> Configure Build Path...-> Libraries 탭 -> add library -> server runtime -> 선택 -> 새로고침

3) Can not find the tag library descriptor for
이클립스 버그로 Java Build Path 에서 Libraries 탭에 Maven Dependencies 에 속해 있다면 이클립스에서 자동으로 인식해서 tag library를 찾아야 하는데, 찾지 못해 WEB-INF/lib 에 해당 라이브러리를 넣어줘야한다.
